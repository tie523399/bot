# 系統管理功能文檔

## 功能概述

為管理員提供完整的系統管理功能，包括 API KEY 更換、管理員管理、機器人重啟等核心維護功能。

## 主要功能

### 1. 🔄 重啟服務器

**功能說明**：
- 快速重啟機器人服務
- 含二次確認機制，防止誤操作
- 重啟前會提醒影響範圍

**注意事項**：
- 中斷所有進行中的對話
- 清空所有暫存資料
- 需要約 5-10 秒重新上線

### 2. 🔑 更換 API KEY

**功能流程**：
1. 點擊「更換 API KEY」
2. 輸入新的 Bot Token
3. 系統自動驗證格式（需包含冒號）
4. 更新 config.py 檔案
5. 選擇立即重啟或稍後重啟

**驗證規則**：
- Token 必須包含冒號（:）
- 自動更新配置檔案
- 需要重啟才能生效

### 3. 👥 管理員管理

**管理功能**：
- **新增管理員**：輸入 Telegram 用戶 ID
- **查看所有用戶**：顯示所有使用過機器人的用戶
- **管理員標記**：用戶列表中顯示 👑 標記

**特別說明**：
- 管理員 ID 只能新增，不能刪除
- 新增後立即生效，無需重啟
- 同步更新 config.py 檔案

### 4. 📱 查看 Bot 資訊

**顯示內容**：
- Bot ID
- Bot 用戶名
- Bot 名稱
- 是否支援內聯查詢
- Python 版本
- 啟動時間

### 5. 🗄️ 資料庫備份

**備份功能**：
- 一鍵備份完整資料庫
- 自動產生時間戳檔名
- 顯示備份檔案大小
- 格式：`orders_backup_YYYYMMDD_HHMMSS.db`

### 6. 📤 匯出訂單

**匯出內容**：
- 訂單編號、時間
- 用戶資訊
- 商品明細
- 訂單狀態
- 金額統計

**檔案格式**：Excel (.xlsx)

### 7. 📢 推播訊息

**推播流程**：
1. 點擊「推播訊息」
2. 輸入要發送的訊息內容
3. 系統自動發送給所有用戶
4. 顯示成功/失敗統計

## 使用權限

所有系統管理功能僅限管理員使用，檢查 `ADMIN_IDS` 設定。

## 操作入口

```
/admin → 系統設定 → 選擇功能
```

## 安全設計

1. **二次確認**：重要操作都有確認機制
2. **權限檢查**：每個功能都驗證管理員身份
3. **錯誤處理**：完善的異常捕獲和提示
4. **自動備份**：修改前保留原始設定

## 技術實現

- **配置更新**：使用正規表達式安全更新 config.py
- **進程重啟**：使用 `os.execv` 實現平滑重啟
- **資料備份**：使用 `shutil.copy2` 保留檔案屬性
- **對話管理**：ConversationHandler 處理多步驟操作

## 注意事項

1. 更換 API KEY 後必須重啟才能生效
2. 重啟會中斷所有使用者的操作
3. 管理員 ID 一旦新增無法透過介面刪除
4. 推播訊息會發送給所有曾經使用過機器人的用戶

## 未來優化

- [ ] 定時自動備份功能
- [ ] 管理員操作日誌
- [ ] API KEY 有效性預檢
- [ ] 分群推播功能 